<!DOCTYPE html>
<html lang="en">
  <%- include('layouts/header');-%>
  <!-- Quill Editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <!-- Quill Editor JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Write your blog post...',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link', 'image'],
            ['clean']
          ]
        }
      });

      // Store Quill content in hidden textarea on form submit
      document.querySelector('form').addEventListener('submit', function() {
        document.querySelector('textarea[name="body"]').value = quill.root.innerHTML;
      });
    });
  </script>
  <style>
    #editor {
      height: 400px;
      background-color: white;
    }
  </style>

  <body>
    <%- include('layouts/navbar');-%>

    <!-- Page Header -->
    <header class="masthead" style="background-image: url('/img/post-bg.jpg')">
      <div class="overlay"></div>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <div class="page-heading">
              <h1>Create new Post</h1>
              <span class="subheading">Add New Blog Post.</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <!-- Display validation errors -->
          <% if (errors && errors.length > 0) { %>
            <div class="alert alert-danger" role="alert">
              <strong>Please fix the following errors:</strong>
              <ul>
                <% errors.forEach(error => { %>
                  <li><%= error %></li>
                <% }); %>
              </ul>
            </div>
          <% } %>

          <form
            action="/posts/store"
            method="POST"
            enctype="multipart/form-data"
          >
            <div class="control-group">
              <div class="form-group floating-label-form-group controls">
                <label>Title</label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Title"
                  id="Title"
                  name="title"
                  value="<%= formData.title || '' %>"
                />
              </div>
              <div class="form-group floating-label-form-group controls">
                <label>Username</label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Username"
                  id="username"
                  name="username"
                  value="<%= formData.username || (user ? user.username : '') %>"
                />
              </div>
            <div class="control-group">
              <div class="form-group floating-label-form-group controls">
                <label>Blog Post Content</label>
                <div id="editor"></div>
                <textarea
                  style="display: none;"
                  class="form-control"
                  id="body"
                  name="body"
                ><%= formData.body || '' %></textarea>
              </div>
              <div class="control-group">
                <div class="form-group floating-label-form-group controls">
                  <label>Image (Optional - Images only: JPG, PNG, GIF, WebP - Max 5MB)</label>
                  <input
                    type="file"
                    class="form-control"
                    id="image"
                    name="image"
                    accept="image/jpeg,image/png,image/gif,image/webp"
                    onchange="validateImageFile(this)"
                  />
                  <small style="color: #666; display: block; margin-top: 5px;">
                    Supported formats: JPG, PNG, GIF, WebP. Maximum file size: 5MB
                  </small>
                  <div id="fileError" style="color: red; margin-top: 5px; display: none;"></div>
                </div>
              </div>
            <br />
            <div class="form-group">
              <button
                type="submit"
                class="btn btn-primary"
                id="saveBlogPostButton"
              >
                Save Blog Post
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      function validateImageFile(input) {
        const fileError = document.getElementById('fileError');
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        const maxSize = 5 * 1024 * 1024; // 5MB

        fileError.style.display = 'none';
        fileError.textContent = '';

        if (input.files && input.files[0]) {
          const file = input.files[0];

          // Check file type
          if (!allowedTypes.includes(file.type)) {
            fileError.textContent = 'Invalid file type. Only JPG, PNG, GIF, and WebP are allowed.';
            fileError.style.display = 'block';
            input.value = '';
            return;
          }

          // Check file size
          if (file.size > maxSize) {
            fileError.textContent = 'File size exceeds 5MB limit. Please choose a smaller image.';
            fileError.style.display = 'block';
            input.value = '';
            return;
          }
        }
      }
    </script>

    <hr />

    <%- include('layouts/footer');-%> <%- include('layouts/scripts');-%>
  </body>
</html>
